êµ¬í˜„ ê°€ì´ë“œ (Backend & Frontend)
ì‚¬ì¥ë‹˜ ë§ì”€ëŒ€ë¡œ UIê¹Œì§€ í™•ì‹¤í•˜ê²Œ ì±™ê²¨ì„œ ì½”ë“œë¥¼ ìˆ˜ì •í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

1. Backend: scheduler.py (ìˆ˜ì •)
ClinicalTrials.govì—ì„œ **ìƒíƒœ(Status)**ì™€ **ì¤‘ë‹¨ ì‚¬ìœ (Why Stopped)**ë¥¼ ê¸ì–´ì˜¤ë„ë¡ ë¡œì§ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

Python
# app/api/scheduler.py ë‚´ process_clinical_trials_data í•¨ìˆ˜ ìˆ˜ì • ë¶€ë¶„

# ... (ê¸°ì¡´ ì½”ë“œ) ...
                
                # [NEW] ìƒíƒœ ë° ê²°ê³¼ ë§¤í•‘ ë¡œì§
                status_module = protocol.get("statusModule", {})
                overall_status = status_module.get("overallStatus", "Unknown")
                why_stopped = status_module.get("whyStopped", "") # ì‹¤íŒ¨ ì‚¬ìœ  ì¶”ì¶œ
                
                outcome_type = "Unknown"
                if overall_status in ["COMPLETED", "APPROVED"]:
                    outcome_type = "Success"
                elif overall_status in ["TERMINATED", "WITHDRAWN", "SUSPENDED"]:
                    outcome_type = "Failure"
                elif overall_status in ["RECRUITING", "ACTIVE_NOT_RECRUITING", "ENROLLING_BY_INVITATION"]:
                    outcome_type = "Ongoing"

                # [NEW] ì´ë¦„ ì—†ëŠ” ì•½ë¬¼ ì²˜ë¦¬ (3ìˆœìœ„ ì „ëµ)
                final_name = drug_name
                if not final_name or final_name == "Unknown":
                    # íƒ€ê²Ÿ ì •ë³´ë¼ë„ ìˆìœ¼ë©´ í™œìš©
                    target_cond = conditions[0] if conditions else "Solid Tumor"
                    final_name = f"Unnamed {target_cond} ADC ({nct_id})"

                new_entry = {
                    "name": final_name, # ë³´ì •ëœ ì´ë¦„ ì‚¬ìš©
                    "category": "clinical_trial",
                    "description": f"Clinical Trial {nct_id}: {record['title']}",
                    "properties": {
                        **record,
                        "overall_status": overall_status, # ì›ë³¸ ìƒíƒœ ì €ì¥
                        "why_stopped": why_stopped        # ì¤‘ë‹¨ ì‚¬ìœ  ì €ì¥
                    },
                    "status": "draft",
                    "enrichment_source": "clinical_trials",
                    "raw_data": study,
                    
                    # [NEW] í•µì‹¬ ë¶„ì„ í•„ë“œ ì¶”ê°€
                    "outcome_type": outcome_type,
                    "failure_reason": why_stopped if outcome_type == "Failure" else None
                }
# ... (ì´í•˜ ë™ì¼) ...

Backend: admin.py (ìˆ˜ì •)
í”„ë¡ íŠ¸ì—”ë“œì— ë°ì´í„°ë¥¼ ë‚´ë ¤ì¤„ ë•Œ outcome_typeê³¼ failure_reasonì„ í¬í•¨ì‹œí‚µë‹ˆë‹¤.

Python
# app/api/admin.py

class GoldenSetDraft(BaseModel):
    # ... ê¸°ì¡´ í•„ë“œ ...
    id: str
    drug_name: str
    target: str
    payload: Optional[str]
    linker: Optional[str]
    enrichment_source: str
    created_at: str
    # [NEW] UI í‘œì‹œìš© í•„ë“œ ì¶”ê°€
    outcome_type: Optional[str]  # Success, Failure, Ongoing
    failure_reason: Optional[str]

# get_golden_set_drafts í•¨ìˆ˜ ìˆ˜ì •
@router.get("/goldenset/drafts", response_model=List[GoldenSetDraft])
async def get_golden_set_drafts():
    # ...
    for item in response.data:
        drafts.append(GoldenSetDraft(
            # ... ê¸°ì¡´ ë§¤í•‘ ...
            outcome_type=item.get("outcome_type"), # DB ì»¬ëŸ¼ ë§¤í•‘
            failure_reason=item.get("failure_reason")
        ))
    return drafts

    Frontend: UI êµ¬í˜„ (StagingAreaTab.tsx ë˜ëŠ” DataOperations.tsx)
ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì…ë‹ˆë‹¤. ë°ì´í„°ë¥¼ ë°›ì•„ì™€ì„œ í™”ë©´ì— **ë°°ì§€(Badge)**ë¡œ ì˜ˆì˜ê²Œ ë³´ì—¬ì£¼ëŠ” ì½”ë“œì…ë‹ˆë‹¤.

TypeScript
// frontend/src/pages/Admin/components/StagingAreaTab.tsx (ì˜ˆì‹œ)

import { Badge } from "@/components/ui/badge"
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip"
import { AlertCircle, CheckCircle2, Clock } from "lucide-react"

// 1. ê²°ê³¼ì— ë”°ë¥¸ ë°°ì§€ ì»´í¬ë„ŒíŠ¸ ì •ì˜
const OutcomeBadge = ({ type, reason }: { type: string; reason?: string }) => {
  if (type === 'Success') {
    return (
      <Badge variant="outline" className="bg-green-100 text-green-800 border-green-200 flex gap-1 items-center">
        <CheckCircle2 className="w-3 h-3" /> Success
      </Badge>
    )
  }
  
  if (type === 'Failure') {
    return (
      <TooltipProvider>
        <Tooltip>
          <TooltipTrigger>
            <Badge variant="outline" className="bg-red-100 text-red-800 border-red-200 flex gap-1 items-center cursor-help">
              <AlertCircle className="w-3 h-3" /> Failure
            </Badge>
          </TooltipTrigger>
          <TooltipContent>
            <p>ì‚¬ìœ : {reason || "Unknown reason"}</p>
          </TooltipContent>
        </Tooltip>
      </TooltipProvider>
    )
  }

  if (type === 'Ongoing') {
    return (
      <Badge variant="outline" className="bg-blue-50 text-blue-700 border-blue-200 flex gap-1 items-center">
        <Clock className="w-3 h-3" /> Ongoing
      </Badge>
    )
  }

  return <Badge variant="secondary">Unknown</Badge>
}

// 2. í…Œì´ë¸” ì»¬ëŸ¼ ì •ì˜ (TanStack Table ì˜ˆì‹œ)
const columns = [
  // ... (ê¸°ì¡´ Name, Target ì»¬ëŸ¼) ...
  
  {
    accessorKey: "outcome_type",
    header: "Outcome",
    cell: ({ row }) => (
      <OutcomeBadge 
        type={row.original.outcome_type} 
        reason={row.original.failure_reason} 
      />
    ),
  },
  
  // ... (Actions ì»¬ëŸ¼) ...
]


ë¶€ë¡

GOLDEN_SET_INTELLIGENCE_SPEC.md
ğŸ§  Project AstraForge: Intelligent Golden Set Pipeline
Priority: High Goal: ìœ íœ´ ìƒíƒœì¸ LLM ë¦¬ì†ŒìŠ¤ë¥¼ í™œìš©í•˜ì—¬, ClinicalTrials.govì˜ Raw ë°ì´í„°ë¥¼ **"ê³ í’ˆì§ˆ ê³¨ë“ ì…‹(Structured Ground Truth)"**ìœ¼ë¡œ ìë™ ë³€í™˜í•©ë‹ˆë‹¤.

1. ğŸ—ï¸ Architecture Change (LLM Role Assignment)
ë‹¨ìˆœ í¬ë¡¤ë§ì´ ì•„ë‹Œ **"AI ê¸°ë°˜ ë°ì´í„° ì •ì œ íŒŒì´í”„ë¼ì¸"**ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•©ë‹ˆë‹¤.

Component,Current Status,New Role (To-Be),Model
Scheduler,Raw Data ì €ì¥,Data Refiner (ì •ì œ),gpt-4o-mini
Name Logic,ì—†ìŒ (Unknown),Code Name Detective,gpt-4o-mini
Outcome Logic,ë‹¨ìˆœ ë§¤í•‘,Failure Analyst,gpt-4o-mini
Gemini,PubMed í•„í„°ë§,PubMed Gatekeeper (ìœ ì§€),gemini-2.0-flash


Backend Implementation (app/services/scheduler.py)
ì§€ì¹¨: ê¸°ì¡´ scheduler.pyì˜ process_clinical_trials_data í•¨ìˆ˜ë¥¼ ì•„ë˜ ë¡œì§ìœ¼ë¡œ ì „ë©´ êµì²´í•˜ì‹­ì‹œì˜¤.

âœ… 2.1. LLM Helper Functions (ì¶”ê°€)
LLMì—ê²Œ **"ì´ë¦„ ì°¾ê¸°"**ì™€ **"ê²°ê³¼ ë¶„ì„"**ì„ ì‹œí‚¤ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. ë¹„ìš© íš¨ìœ¨ì ì¸ gpt-4o-minië¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from app.core.config import settings

# [Cost Strategy] ë°ì´í„° ì²˜ë¦¬ìš© ê°€ì„±ë¹„ ëª¨ë¸
llm_refiner = ChatOpenAI(
    model=settings.FAST_LLM, # gpt-4o-mini (config.pyì— ì •ì˜ í•„ìš”)
    temperature=0,
    api_key=settings.OPENAI_API_KEY
)

async def refine_drug_data_with_llm(title: str, description: str, raw_status: str, why_stopped: str) -> dict:
    """
    LLMì„ ì‚¬ìš©í•˜ì—¬ ì•½ë¬¼ ì´ë¦„ ì¶”ì¶œ ë° ì„ìƒ ê²°ê³¼ ë¶„ì„ ìˆ˜í–‰
    """
    system_prompt = """You are an expert Clinical Data Analyst. 
    Your task is to extract structured information from unstructured clinical trial text.
    
    1. **Drug Name Extraction:** - Find the specific ADC code name (e.g., 'DS-8201', 'IMGN-632') or generic name.
       - If only 'Anti-HER2 ADC' is found, output 'Unknown'.
       - Do NOT invent names.
       
    2. **Outcome Analysis:**
       - Determine if the trial was a 'Success', 'Failure', or 'Ongoing'.
       - If 'Failure' (Terminated/Withdrawn), summarize the *scientific reason* (Toxicity, Lack of Efficacy) in 1 short sentence.
       
    Output JSON format:
    {
        "extracted_name": "DS-8201a",
        "outcome_type": "Failure", 
        "failure_reason": "Terminated due to Grade 3 interstitial lung disease."
    }
    """
    
    user_prompt = f"""
    Title: {title}
    Description: {description}
    Status: {raw_status}
    Why Stopped: {why_stopped}
    """
    
    prompt = ChatPromptTemplate.from_messages([
        ("system", system_prompt),
        ("user", user_prompt)
    ])
    
    try:
        chain = prompt | llm_refiner
        # JSON ëª¨ë“œ ê°•ì œ (Structured Output)
        response = await chain.ainvoke({})
        
        # ë¬¸ìì—´ íŒŒì‹± (í˜¹ì€ structured_output ì‚¬ìš©)
        import json
        content = response.content.strip()
        if "```json" in content:
            content = content.split("```json")[1].split("```")[0]
        return json.loads(content)
        
    except Exception as e:
        print(f"LLM Refine Error: {e}")
        return {"extracted_name": "Unknown", "outcome_type": "Unknown", "failure_reason": None}

        2.2. Main Logic Update
í¬ë¡¤ë§ ë£¨í”„ ì•ˆì—ì„œ ìœ„ LLM í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ë°ì´í„°ë¥¼ ì±„ì›Œ ë„£ìŠµë‹ˆë‹¤.


async def process_clinical_trials_data(job_id: str):
    # ... (ê¸°ì¡´ API í˜¸ì¶œ ë¡œì§ ìœ ì§€) ...
    
    for study in studies:
        try:
            # ... (ê¸°ë³¸ ë°ì´í„° íŒŒì‹±) ...
            
            # [LLM Injection] ë°ì´í„° ì •ì œ ìš”ì²­
            # ì´ë¦„ì´ ì—†ê±°ë‚˜, ìƒíƒœê°€ 'Terminated'ì¸ ê²½ìš° LLMì—ê²Œ ë¶„ì„ ìš”ì²­
            should_refine = (
                drug_name in ["Unknown", "Drug:"] or 
                protocol.get("statusModule", {}).get("overallStatus") in ["TERMINATED", "WITHDRAWN"]
            )
            
            refined_data = {}
            if should_refine:
                refined_data = await refine_drug_data_with_llm(
                    title=id_module.get("officialTitle"),
                    description=str(protocol.get("descriptionModule", {})),
                    raw_status=protocol.get("statusModule", {}).get("overallStatus"),
                    why_stopped=protocol.get("statusModule", {}).get("whyStopped", "")
                )
            
            # [Merge] LLMì´ ì°¾ì€ ì´ë¦„ ì ìš©
            final_name = drug_name
            if refined_data.get("extracted_name") and refined_data["extracted_name"] != "Unknown":
                final_name = refined_data["extracted_name"]
            
            # ì´ë¦„ì´ ì—¬ì „íˆ ì—†ìœ¼ë©´ Fallback ê·œì¹™ ì ìš©
            if final_name == "Unknown":
                 final_name = f"Unnamed ADC ({nct_id})"

            # [Merge] LLMì´ ë¶„ì„í•œ ê²°ê³¼ ì ìš©
            outcome_type = refined_data.get("outcome_type", "Unknown")
            failure_reason = refined_data.get("failure_reason")

            # DB ì €ì¥ (í•„ë“œ ì¶”ê°€ë¨)
            new_entry = {
                "name": final_name,
                "category": "clinical_trial",
                "description": f"[{outcome_type}] {record['title']}",
                "properties": {
                    **record,
                    "ai_analysis": refined_data # AI ë¶„ì„ ì›ë³¸ ë³´ê´€
                },
                "status": "draft",
                "enrichment_source": "clinical_trials_ai_refined", # ì†ŒìŠ¤ í‘œì‹œ
                
                # í•µì‹¬ ë¶„ì„ í•„ë“œ
                "outcome_type": outcome_type,
                "failure_reason": failure_reason
            }
            
            # ... (supabase insert) ...


            Frontend Update (GoldenSetDraft UI)
ì§€ì¹¨: ê´€ë¦¬ìê°€ "AIê°€ ë¶„ì„í•œ ê²°ê³¼"ë¥¼ í•œëˆˆì— ì•Œì•„ë³¼ ìˆ˜ ìˆë„ë¡ ë°°ì§€(Badge)ì™€ ì•„ì´ì½˜ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

AI Tag: ì´ë¦„ ì˜†ì— âœ¨ AI Extracted ë°°ì§€ ì¶”ê°€ (LLMì´ ì´ë¦„ì„ ì°¾ì•„ë‚¸ ê²½ìš°).

Outcome Badge:

Success: ğŸŸ¢ (ì´ˆë¡ìƒ‰)

Failure: ğŸ”´ (ë¹¨ê°„ìƒ‰) + Tooltipìœ¼ë¡œ failure_reason í‘œì‹œ.

âš™ï¸ Config Update (app/core/config.py)
ê°€ì„±ë¹„ ëª¨ë¸ ì„¤ì •ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤.

Python
class Settings(BaseSettings):
    # ...
    SMART_LLM: str = "gpt-4o"      # ë¦¬í¬íŠ¸ìš© (ë˜‘ë˜‘í•¨)
    FAST_LLM: str = "gpt-4o-mini"  # ë°ì´í„° ì •ì œìš© (ë¹ ë¦„, ì‹¸ìŒ)